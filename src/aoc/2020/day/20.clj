(ns aoc.2020.day.20
  (:require [clojure.string :as s]
            [clojure.test :as t]
            [hashp.core]))

;; stop hashp from printing escape codes
(alter-var-root #'puget.printer/*options* #(merge % {:print-color false}))

(def input "Tile 1759:\n.##.#..#..\n..........\n..#..#...#\n##....####\n###.##.##.\n.#.#.#..#.\n......#..#\n##.....#..\n..........\n.##....#..\n\nTile 3803:\n#.#.#.#.#.\n#.........\n#.....#...\n#...#..#.#\n#....#....\n#..#.#...#\n.##.#.##.#\n#........#\n#..#...#..\n..#####.#.\n\nTile 2351:\n......###.\n##...##.##\n.........#\n..#.#.....\n....#.##..\n#.#.#.#.##\n.##.#.##.#\n....#...##\n#..#...###\n#.##...##.\n\nTile 2467:\n#####.#.##\n#........#\n#.#....###\n.......##.\n....#....#\n#.........\n.......#.#\n##.#..#..#\n.#....#.##\n..#....###\n\nTile 1933:\n##.....###\n#.#......#\n....#...##\n#.###.....\n#.##.#..#.\n....#....#\n....##....\n##........\n#..##....#\n.#.#.#...#\n\nTile 2971:\n#.#.#.#..#\n.........#\n......#..#\n##...#....\n...###....\n#....##...\n.....#.#..\n#....#.#.#\n#.......#.\n.###...#.#\n\nTile 2731:\n.....#####\n..##......\n.......##.\n.#........\n#..#.#....\n..........\n#..##.#...\n.#..###...\n#.#..#....\n..#.#.....\n\nTile 2423:\n.####.#...\n#.##.#...#\n.....##...\n##........\n..#..#..##\n#...######\n....#...##\n.....##...\n...#...###\n##.#..###.\n\nTile 1877:\n.#...##..#\n#..##....#\n#.##......\n...#......\n.#........\n#........#\n#.....##.#\n#.....##..\n.........#\n..####.#..\n\nTile 3461:\n....##.##.\n....##....\n###......#\n#.#...#...\n#........#\n.##..#.#.#\n#.....#.#.\n#.......#.\n#........#\n#.#.##.###\n\nTile 2137:\n##.#.#...#\n#..#.##..#\n.##......#\n#..#.#...#\n###.#....#\n#........#\n#....#..#.\n#...##.##.\n...#.###..\n##...#...#\n\nTile 2647:\n##.##..#..\n......#..#\n.....#....\n##......##\n#.#.#..###\n##.......#\n#...###...\n##...##..#\n.....#....\n###....##.\n\nTile 3253:\n......#.#.\n#.......#.\n##..##....\n#.#.##...#\n.....#...#\n...#..#..#\n#.....#...\n.#...#....\n.#..#.##..\n.###...##.\n\nTile 1409:\n.###.###.#\n#..#.##.##\n........##\n.###......\n#####.####\n..#..#.#.#\n..#...##.#\n..##..#.##\n....#....#\n####.....#\n\nTile 2503:\n###.....##\n.....#..#.\n#...##....\n.##..##..#\n...#...#.#\n.#..#.#...\n#...#...##\n#.........\n##...#...#\n...#....#.\n\nTile 1879:\n.######.##\n......#..#\n..#.#..##.\n..........\n#..#.....#\n.##.......\n#.......##\n..........\n.........#\n#.#.#.##..\n\nTile 3739:\n#..#.#....\n#.....#...\n#.........\n##....#..#\n###..##..#\n..#...#..#\n#.####....\n.##.......\n.##......#\n###..#.###\n\nTile 2713:\n..#..#..#.\n#.........\n.#.....###\n.#.##.#.##\n.#.#.##...\n.##..#.#.#\n..####..#.\n#..##.....\n#....#....\n.#..####..\n\nTile 2243:\n#.##...##.\n...#......\n..#..#..##\n....#....#\n#....####.\n.##.#...##\n#..#..#...\n#..###...#\n#.##.#####\n.#..#.###.\n\nTile 3307:\n...####..#\n....#.....\n.###......\n..#.......\n.....#...#\n#...#....#\n#...#.....\n.........#\n#..###....\n#####..#.#\n\nTile 2161:\n###.#.#..#\n#.#...###.\n.##......#\n##.#..#.#.\n#.#.#..#.#\n#..#.#....\n...#....##\n#.##...#.#\n#......#..\n..#.#.####\n\nTile 3257:\n....##..##\n#.........\n..#..##.##\n.#......#.\n#...#....#\n#.#...#.#.\n....##...#\n###....##.\n.##...#..#\n.#...#..##\n\nTile 1997:\n..#.##.###\n....#.....\n..#......#\n.#.#..#.#.\n###...#.##\n.#......##\n..........\n#........#\n..#..#..##\n##.#.#####\n\nTile 2741:\n#####..###\n#..#.....#\n#...#...#.\n....##...#\n...#......\n#..##.#...\n###....###\n........#.\n##.###....\n...#...###\n\nTile 2671:\n##....#..#\n........#.\n.##.#..###\n......##.#\n#..#....##\n....#...#.\n#.#......#\n###......#\n...#......\n..###.##.#\n\nTile 3943:\n####...#.#\n#..##.....\n.#......#.\n......##..\n..#.....##\n#...#....#\n....##.#.#\n..........\n..#....#.#\n..#.....##\n\nTile 1283:\n..##...###\n#..#....#.\n#...#.....\n.#.....##.\n#.##....##\n.#..#...#.\n#....#...#\n##....#...\n.##...####\n##..##.###\n\nTile 3067:\n#.#.#.#.#.\n#..#......\n..##......\n#..#...#.#\n.##.#....#\n......#...\n#...#.#.##\n.#..##..#.\n...#...###\n...##..#..\n\nTile 2957:\n.#..###...\n#........#\n......#.##\n...#..##.#\n###....#.#\n.....#..##\n#.......#.\n#....##.#.\n......#.##\n.##..#..##\n\nTile 1571:\n..#...##.#\n#..####..#\n#.........\n.#.###..##\n#.....##.#\n......#...\n..#.......\n.#........\n........#.\n####.#..##\n\nTile 1481:\n#.#..##...\n#...#....#\n#.....#..#\n..#......#\n.#...#.#.#\n....#..###\n.#.###....\n.....###..\n.#....#..#\n####..#..#\n\nTile 1637:\n#.##...#..\n.........#\n#........#\n.###.....#\n##..#..#..\n.#....#...\n.......#.#\n.....#....\n#..##..#.#\n#..###.#.#\n\nTile 1567:\n####.#.#.#\n...##.....\n......#...\n.#...##...\n#.#....#.#\n#.#......#\n.###.....#\n##..#..#..\n...#......\n########..\n\nTile 1117:\n#..#.#.#.#\n....#....#\n.#.#..##..\n....#.##..\n##..#.....\n...#......\n#....#...#\n...##..#.#\n...#....#.\n.#..#.##..\n\nTile 1663:\n####..#...\n#.#......#\n......#...\n....#..##.\n#......#.#\n...##....#\n#........#\n#.#..#...#\n####.#....\n..####.##.\n\nTile 3079:\n.#....####\n.#......#.\n..........\n......#..#\n###..#.#.#\n...#....##\n..##.#####\n..#.###..#\n....##....\n.#.######.\n\nTile 2011:\n##.###....\n..##.#.##.\n##.##..#..\n##.....##.\n#...#...#.\n.#.##.##.#\n###..#.###\n..#....#..\n#.##..####\n.......##.\n\nTile 1801:\n.#..##..##\n..#.###..#\n....##....\n#...#.#...\n..##......\n#.....#...\n#.........\n..##....##\n#.#.#..#.#\n..#.#..##.\n\nTile 1499:\n...#..####\n#.......#.\n..........\n#.....#..#\n#..###....\n#..#..##.#\n...##.#..#\n..#......#\n..#.......\n#.######..\n\nTile 1061:\n###.#...##\n#..###.##.\n##.#......\n#.#...#...\n.....#..##\n.#....#.#.\n...#...#.#\n...###....\n.##..##.#.\n#.#...#.##\n\nTile 1783:\n#...####.#\n#.....####\n.#........\n......##.#\n..##....##\n..#......#\n#...#.#...\n#........#\n.#...#...#\n.#######..\n\nTile 1301:\n#.....#.##\n#....#...#\n#.##.#...#\n.#..#.#..#\n.#....#.#.\n....##.##.\n##..#...#.\n.#...#.#..\n...#.#....\n..##......\n\nTile 1259:\n#..###..##\n....###..#\n.#...#..#.\n.....#...#\n.#.##.....\n#..#......\n#.#.....#.\n#...#....#\n.....#.##.\n#####...##\n\nTile 3823:\n#..##..#..\n#...#.....\n.#.......#\n#..#.##.#.\n..........\n#....#....\n#.#.....##\n..#.#.#...\n..#......#\n#..####.##\n\nTile 3181:\n#.........\n#......###\n##....##..\n......##.#\n...#.##...\n#.#..#...#\n#.......#.\n##...#....\n#.....##.#\n.####.####\n\nTile 3251:\n...###.##.\n...#.....#\n##...#...#\n#.####..##\n...#.#..##\n..#...#.##\n##....#..#\n.##.......\n...#.#...#\n..##..####\n\nTile 3121:\n#..#....#.\n#..##.#...\n....#....#\n#....#..#.\n...#.....#\n....#.....\n.....#...#\n...###...#\n#..##...#.\n.####.#...\n\nTile 3209:\n##....#...\n##.......#\n.......#..\n###.#...#.\n..........\n..#...#..#\n..#.##..#.\n##..#.....\n#..####...\n###..##..#\n\nTile 1049:\n..#..#....\n....##....\n...#......\n#...#.....\n#..#.....#\n...#.....#\n.#.....##.\n..#.#.##.#\n..##.#.#.#\n.##.###.#.\n\nTile 3671:\n.###......\n..###..#.#\n....#.....\n####......\n#.#.#.....\n#.......#.\n..##...#..\n.....#....\n.##..#....\n.##.#..##.\n\nTile 1171:\n...###.##.\n#.........\n#.........\n#........#\n....##.#.#\n#.....#..#\n##..#.....\n.......#..\n...#.....#\n.#####.###\n\nTile 3259:\n###..##.#.\n#..###..##\n......##..\n..#...#.#.\n...#.#....\n##....#..#\n..#...##.#\n.#....##..\n........#.\n.######...\n\nTile 1601:\n#..#.#.###\n......####\n.#...##...\n#......###\n#...#....#\n#....#.#.#\n#...#..##.\n..###.#...\n#....##..#\n.#.#..###.\n\nTile 2371:\n.#.....#..\n#.#..##...\n.....#####\n###..#.##.\n#.####.#..\n........#.\n###......#\n.........#\n.......###\n.##.###.#.\n\nTile 2153:\n.#....#..#\n#....#..##\n#.........\n.....##...\n##.....##.\n#.#......#\n.#..##...#\n##.#.#.#..\n...#.....#\n.#.##.##..\n\nTile 2269:\n.#.#.#....\n...#.....#\n..#....#..\n#.#.......\n.#.#......\n........##\n..........\n...#.....#\n#.##...#.#\n#.#....#..\n\nTile 1291:\n##.##..#.#\n##.#......\n##..#.....\n###...##..\n.#..#.#..#\n##...#...#\n..#####...\n###..####.\n#.#......#\n.#.#.##...\n\nTile 1487:\n.##..##...\n..#.#.##..\n#...#...##\n..#.#...#.\n.###...#.#\n..##.....#\n...#.#...#\n#.....#..#\n#..#......\n.##.#.####\n\nTile 3023:\n########..\n.#..#..#.#\n###.###...\n#.#......#\n##.#.#..#.\n.....#....\n##..#.....\n.##.......\n.##......#\n###..#...#\n\nTile 2887:\n..#.#..#..\n...#......\n.......#.#\n.......#..\n#......#.#\n#...#....#\n..#....###\n........#.\n.#...#.##.\n#.#..#.#..\n\nTile 2333:\n#....##.#.\n.#.......#\n#....##..#\n........##\n#.........\n..........\n...##.#..#\n#.#.#.....\n.........#\n###..#.##.\n\nTile 2311:\n...####.#.\n##.#......\n#.#.......\n#.##....##\n...#.#..##\n..#....#..\n###.......\n..#.##....\n.#.###...#\n#...###.##\n\nTile 1039:\n.#..#.#.#.\n....###...\n##.......#\n.##.......\n..#......#\n..........\n#......#..\n#....##..#\n#.....#..#\n..#.##..##\n\nTile 3571:\n....#....#\n#...#...##\n##......##\n..........\n..#.......\n.........#\n...##.##.#\n.#####....\n.....#....\n.#..#.....\n\nTile 2221:\n##.#.###..\n.###..#...\n.#...#...#\n#....#....\n#..#.#....\n#.#......#\n#......###\n..##.#....\n#...###..#\n#.##......\n\nTile 1361:\n.#.#.#.#..\n.##..##...\n...##.....\n#...##..##\n##.##..#.#\n...#..#...\n#...#..#..\n#........#\n...#......\n#..#...###\n\nTile 3637:\n.#####...#\n#........#\n#..##.#.#.\n#.........\n#..##.....\n.#....#...\n...#....##\n...###..#.\n#....#.#..\n##.#.#..##\n\nTile 3083:\n.#....#.##\n#....#....\n#...#...#.\n....#....#\n.#.#..##.#\n######..#.\n#.###.....\n.#........\n#........#\n###..###..\n\nTile 1619:\n.###...##.\n#....#...#\n..#..#....\n#...#.####\n#.....#.#.\n#..#......\n..#..##..#\n#..###....\n#..#.#.#..\n#..##..#.#\n\nTile 2063:\n.#..#.....\n#....#....\n#..#.###..\n#.#...#...\n#....##.##\n#...##..#.\n#........#\n..#...#...\n...#..#...\n#......#..\n\nTile 3911:\n##..##....\n##.......#\n###....###\n##.#.###.#\n..#.......\n#..#.#.###\n.#.#.#.###\n####..####\n..##.##.#.\n......#..#\n\nTile 2447:\n#.......#.\n##...##.#.\n#.#..#...#\n......###.\n.#....#.##\n..#...#..#\n....#.#..#\n#...#....#\n..#.......\n...##.#...\n\nTile 3191:\n.#....#.#.\n#..#...#.#\n........##\n....#..#..\n#......#.#\n#...##....\n#......#.#\n.##...#...\n##....#...\n#.####...#\n\nTile 1733:\n..###..###\n..........\n#.##....#.\n#..#...#.#\n#..#.....#\n..........\n.........#\n.......#..\n#........#\n.#.##.....\n\nTile 3533:\n###.#...##\n.........#\n...##.#.#.\n#........#\n#..#...#..\n.#.......#\n#.#...#...\n##.#..##..\n#...##.###\n...#.#.#.#\n\nTile 3767:\n.######..#\n##.#####..\n....#.#...\n#....##..#\n.....#.#.#\n#...#..#..\n#...#...##\n#.###.#..#\n..........\n#.#.#..#.#\n\nTile 2531:\n.#.#...#..\n....#....#\n......#..#\n#...#....#\n##.......#\n.#..####..\n..##..#.##\n#........#\n#.....####\n..##..####\n\nTile 3329:\n##..#.##.#\n....#...#.\n##..#..#.#\n##..#.#.##\n...#...#..\n.#####...#\n...#....##\n###...#...\n..........\n#######.##\n\nTile 2473:\n##.#.####.\n#.#.......\n.......#.#\n#.#.#.#...\n....#..#..\n#####....#\n#..#..##..\n#...#.....\n.....#.#.#\n##.#...##.\n\nTile 2851:\n#......#..\n#.#....##.\n..........\n#..##...##\n#.#.#....#\n#...#.....\n#.#...##.#\n##.#.#..##\n#.#.......\n##.##.....\n\nTile 2111:\n#..###..#.\n#...#.#.##\n#.....#...\n#.....####\n#..##.#...\n....##..#.\n....#.....\n...###.###\n..#.#.....\n#..#..#.##\n\nTile 3001:\n..#.###...\n......##..\n..#...####\n#..#.#....\n##..#.....\n..#.....##\n.....##..#\n.#.#..#..#\n#.....#.##\n..##......\n\nTile 2549:\n.#..#..###\n#..#.#.##.\n.....#....\n####..#..#\n......#.#.\n#.....#.#.\n..........\n##..#...##\n...##....#\n...###..#.\n\nTile 3989:\n.......#.#\n..##.#.###\n#..##..#.#\n..........\n.#.##..#..\n.....#...#\n..#.#..###\n.....###..\n##...##...\n.####.....\n\nTile 3049:\n##...#####\n###.#...##\n#....#...#\n#........#\n#....#....\n##..##..#.\n..###.#..#\n#.###.....\n#...#.....\n#.####.#.#\n\nTile 1721:\n..###.#.##\n#........#\n.#.#...#.#\n#.##.#.###\n#..###..##\n.....##..#\n##.#.##..#\n#......#.#\n....##.#..\n.#.......#\n\nTile 2791:\n###.#.#...\n#....#....\n....##...#\n...#.##.##\n...#...#..\n...###.##.\n.#.#..#..#\n##.##...##\n.##..#.##.\n#..##..###\n\nTile 2083:\n#.#..#..##\n.#....##.#\n..#......#\n#.........\n....##...#\n.......#.#\n..###....#\n###.....#.\n###....##.\n...#.#...#\n\nTile 3613:\n.###.#..#.\n#.#..##..#\n#.###.#...\n.#.....#.#\n......#..#\n......#...\n.#.#...#.#\n#.......##\n......#..#\n#..#.#.#..\n\nTile 1201:\n..#.#...#.\n#.....#...\n#..##..#..\n.#...#...#\n#..##....#\n#..#..#..#\n.##.#..#.#\n#..#......\n...#..#...\n#...##..##\n\nTile 3119:\n#..#.##..#\n#.#...#...\n##....#.#.\n#..#..#.##\n#.........\n...##..##.\n#...#..#.#\n#.........\n#..#....#.\n#.##.#.##.\n\nTile 2459:\n.#....###.\n....#.#...\n#..#.#....\n#...#..#..\n#........#\n.#.#......\n....#...#.\n#...#....#\n..#.#.....\n##.##..###\n\nTile 2341:\n#..#..###.\n#.#......#\n#.#....#.#\n##........\n.#.##..#.#\n.###......\n.......#.#\n##...#.#..\n####...#.#\n.#...###.#\n\nTile 3011:\n###..#..##\n...#.###..\n#........#\n.##.#...#.\n.....#####\n........##\n.........#\n#......#..\n###.......\n#..###.###\n\nTile 3727:\n#.###..##.\n#...#....#\n...#....##\n##..#....#\n.........#\n##..#.....\n#.........\n.##.......\n#.##.###.#\n#..#.#...#\n\nTile 2659:\n#.##.###..\n.........#\n#...#..#..\n.#..#.#...\n....##...#\n#..#.##...\n#.##.....#\n..........\n...##..#..\n#.##..#.#.\n\nTile 2657:\n#...######\n..#...#...\n..#......#\n...#...#..\n......###.\n#......##.\n#..#..#..#\n#.#.#..#..\n.###..#...\n#......###\n\nTile 2789:\n#.....#..#\n...#..###.\n#.#.......\n#........#\n.#.#....#.\n...#.....#\n.#.....###\n##.##....#\n.##...#...\n#####..#.#\n\nTile 1627:\n#.##..#.##\n#...##.#.#\n....#....#\n##..#...##\n.....#...#\n.#..#....#\n........#.\n#.#.###.##\n.#.##.#..#\n.#.###.#..\n\nTile 3167:\n..###.#...\n.....#..##\n#..##.....\n#.#..##.#.\n#.....#.##\n####.....#\n#.###..#..\n.##....#..\n.#..#.....\n#....#.#.#\n\nTile 3229:\n###...#.##\n##....##..\n#.......##\n...##....#\n#.#.....#.\n........##\n##...#...#\n#........#\n..#......#\n..#.....##\n\nTile 2383:\n#.####.###\n.#.#...#..\n####..#.#.\n.#..#.#..#\n..#.#..#..\n##.....#..\n.....#.#.#\n...##..#.#\n##...####.\n##...#.#.#\n\nTile 1381:\n#.#.#.####\n........##\n.#..#..#..\n#.....##..\n.#...#.#.#\n#.....#..#\n...##..#..\n..####....\n##........\n..######.#\n\nTile 3089:\n..#..####.\n.....#...#\n.#........\n.###..#.##\n#..#.....#\n#..##..#.#\n##.....#.#\n#...#.#...\n.....#...#\n...##.##.#\n\nTile 1229:\n##..#....#\n##.#.#...#\n#...#..###\n#.........\n.......#..\n...#.....#\n#.#.......\n..........\n#...#.##..\n.#...#####\n\nTile 3691:\n.####.#.#.\n#..#.##..#\n.....#.###\n#....#..##\n##........\n#...##.#.#\n#.....#..#\n..#.#.....\n.##...##.#\n#.##..#...\n\nTile 1019:\n...##.#..#\n#..#.....#\n.........#\n##..#..#..\n#.....#...\n#....#.#..\n#.#..#....\n#.#...#..#\n##....#..#\n.#.#####..\n\nTile 3217:\n#.##..##..\n#.#...###.\n#.#....#.#\n.#.#......\n##.......#\n...#.#..#.\n##.#......\n#.#.....##\n.#........\n.######...\n\nTile 2833:\n....###.##\n##........\n....###...\n....##....\n.#.#......\n..#...##.#\n#.##....##\n.###.#....\n...##..#.#\n.#.#....#.\n\nTile 1493:\n...#.#.#.#\n#.#..#....\n#...#....#\n.##......#\n..#.##...#\n#.........\n.........#\n##....#..#\n#.#.......\n.#.#..#..#\n\nTile 2963:\n.##..#..##\n#.#.....#.\n#........#\n#..#.#....\n#........#\n##....#..#\n#.....##.#\n###......#\n.#....#...\n......#..#\n\nTile 1873:\n.###.#.#..\n...##.....\n#...#.....\n.......#.#\n.#.....#.#\n...#....#.\n..#..#....\n##..#.#...\n..#....###\n#.##.#####\n\nTile 2539:\n#..#...#.#\n##.......#\n#..#..#..#\n......#.#.\n..........\n.###.#.##.\n##.#.##..#\n.......###\n..#.###...\n##.####...\n\nTile 2339:\n#.###.#.##\n#.....#..#\n..........\n#.........\n......##.#\n#..#.###.#\n#.........\n.......#..\n.........#\n...##.....\n\nTile 1303:\n....##.###\n#.#..#...#\n.........#\n#.....#.##\n.#..#....#\n.......#.#\n...#....#.\n#.####...#\n.#.#....#.\n##...#..#.\n\nTile 3539:\n.#........\n.#..#.##.#\n###..##.##\n....#....#\n#......#..\n#.###.#.##\n.........#\n..#...#.#.\n##......#.\n.#..#....#\n\nTile 1153:\n#..##.#.##\n#.#...#.##\n#..##..#..\n#..#..#..#\n####.#.###\n#...#...#.\n#.....#...\n#..##..#.#\n.##.###.##\n####.#.###\n\nTile 2273:\n#.#....##.\n###..####.\n##....####\n##.....#..\n..#.....#.\n....#...##\n##........\n.#.......#\n#........#\n.#..#.##.#\n\nTile 2543:\n..###...#.\n#..#..#...\n####....#.\n...###..#.\n...#.#..##\n###.#.....\n#.........\n##.....#..\n..#...#...\n..####...#\n\nTile 1451:\n.#.####.##\n.....#.#.#\n.##.......\n..#......#\n...#.#..##\n..#......#\n#...##..##\n#.#.......\n#.........\n#..#..#...\n\nTile 3203:\n..###.....\n#...#....#\n###..##...\n..........\n###....#..\n........##\n...#......\n#......##.\n....#.#..#\n.###.##...\n\nTile 1009:\n..#.#..##.\n##..#....#\n#..##...##\n##...#...#\n##...#..#.\n...#...###\n....##.#..\n....#.##.#\n...##.####\n....#.#...\n\nTile 1531:\n.....#.##.\n.#.####...\n....##.#.#\n#...#...##\n#....##.#.\n###......#\n..#..##...\n#..#.....#\n..#....#.#\n###.#..#..\n\nTile 3617:\n.##.##.#.#\n#....#..#.\n.#....#.#.\n#.........\n.#...##..#\n.##.#.##.#\n#.#.#.##.#\n.....###..\n.#..#.##.#\n.#.....##.\n\nTile 2617:\n#..##.#..#\n#..#....#.\n.#.......#\n#..#......\n.###.####.\n..#.....##\n..#..#....\n..#.......\n....#.....\n#....#####\n\nTile 1847:\n..#.#...#.\n.##....#..\n###.#.##.#\n..#.##..##\n#####...#.\n.###.#...#\n#.......##\n..#.#..#..\n...##.#...\n.###.#.##.\n\nTile 3299:\n..#.##.##.\n...##.....\n#........#\n...#.##.#.\n.#####....\n#..#.#..##\n#..#..#.##\n..#..#...#\n#.#.#.....\n.#...#..#.\n\nTile 2591:\n......#.#.\n#....#...#\n##......##\n...#...#..\n..#.......\n.....#.#.#\n#.......##\n..###...##\n#..#..##.#\n.....#.##.\n\nTile 3169:\n###...##.#\n..#..##..#\n#..###...#\n.#..#....#\n..#......#\n....#.#...\n.##.#..###\n..##...##.\n###.......\n##..#.####\n\nTile 3697:\n..#.#.#..#\n.###.#...#\n#.##...##.\n.#.##.#...\n#..##....#\n..........\n#....#....\n.##.......\n#..#.#.##.\n#.....#..#\n\nTile 2551:\n#.##..#..#\n#..#......\n.#..#.....\n#....#..#.\n#.......##\n.#..#....#\n.#........\n....#.....\n.#.##.....\n###.#.#...\n\nTile 2909:\n.....#.#..\n.#.#.....#\n#....##...\n#......##.\n...#......\n##.......#\n......###.\n#..#.##...\n...#...##.\n#.##...###\n\nTile 2027:\n.#.#.####.\n..##.....#\n#...##.###\n.##.#.....\n##.##....#\n....#.#...\n#.##....#.\n..###..#.#\n#...#.#.##\n##..#.##.#\n\nTile 3947:\n#.#.#.##.#\n.#........\n#....##..#\n#.........\n.....#...#\n......#...\n#.#.##...#\n.##.#.....\n.........#\n.###.#...#\n\nTile 3797:\n#...####..\n.#....##..\n#.....#...\n.....#.#.#\n...#..##..\n.....#...#\n......##.#\n.##...#...\n.....##...\n.#..#.#.#.\n\nTile 3187:\n##...#..#.\n#..#..#..#\n#........#\n......#.#.\n......##..\n#.#.......\n#.#......#\n##...#..##\n##..#...##\n####...#.#\n\nTile 1151:\n..#..#..##\n...#.#....\n#.#.#....#\n..#......#\n...##....#\n..#.......\n#......#..\n#.##..#...\n#.#....###\n######.#..\n\nTile 1511:\n#...#.....\n#.######.#\n#.....#...\n....#...#.\n#..###.#.#\n.....#.#.#\n....#....#\n#..#...##.\n#........#\n#....#.##.\n\nTile 2293:\n##...#...#\n#......#..\n.#..#.....\n#...###..#\n##....#..#\n#...##.#.#\n....#.....\n....#.....\n#.....#.##\n##.#.##.##\n\nTile 2131:\n#.#..#.#..\n#..#...#..\n#.##..#...\n....##..#.\n#........#\n#..#.....#\n##.......#\n####.#...#\n.##..#.#..\n###..#..#.\n\nTile 2711:\n..###.....\n..#.......\n..##...##.\n##..#..##.\n.#...#....\n.....#....\n#...#....#\n.##.#.#..#\n#.##.#....\n##.#..##.#\n\nTile 1543:\n##.....##.\n#...###...\n...#.#..#.\n#.#...#.##\n.#.#.###..\n####...###\n#..##..#..\n####..#.##\n#.##...#..\n...#..#.#.\n\nTile 1723:\n.#####.###\n....##....\n##........\n#.......#.\n#..####..#\n.####..##.\n.#........\n#..#..#...\n..........\n..#.#.##..\n\nTile 2819:\n..#..##.##\n.....#....\n#.#.....##\n..#.......\n..##..#.#.\n#....#...#\n#...#...#.\n..#.......\n.........#\n#.#..###..\n")

(def t "Tile 2311:\n..##.#..#.\n##..#.....\n#...##..#.\n####.#...#\n##.##.###.\n##...#.###\n.#.#.#..##\n..#....#..\n###...#.#.\n..###..###\n\nTile 1951:\n#.##...##.\n#.####...#\n.....#..##\n#...######\n.##.#....#\n.###.#####\n###.##.##.\n.###....#.\n..#.#..#.#\n#...##.#..\n\nTile 1171:\n####...##.\n#..##.#..#\n##.#..#.#.\n.###.####.\n..###.####\n.##....##.\n.#...####.\n#.##.####.\n####..#...\n.....##...\n\nTile 1427:\n###.##.#..\n.#..#.##..\n.#.##.#..#\n#.#.#.##.#\n....#...##\n...##..##.\n...#.#####\n.#.####.#.\n..#..###.#\n..##.#..#.\n\nTile 1489:\n##.#.#....\n..##...#..\n.##..##...\n..#...#...\n#####...#.\n#..#.#.#.#\n...#.#.#..\n##.#...##.\n..##.##.##\n###.##.#..\n\nTile 2473:\n#....####.\n#..#.##...\n#.##..#...\n######.#.#\n.#...#.#.#\n.#########\n.###.#..#.\n########.#\n##...##.#.\n..###.#.#.\n\nTile 2971:\n..#.#....#\n#...###...\n#.#.###...\n##.##..#..\n.#####..##\n.#..####.#\n#..#.#..#.\n..####.###\n..#.#.###.\n...#.#.#.#\n\nTile 2729:\n...#.#.#.#\n####.#....\n..#.#.....\n....#..#.#\n.##..##.#.\n.#.####...\n####.#.#..\n##.####...\n##..#.##..\n#.##...##.\n\nTile 3079:\n#.#.#####.\n.#..######\n..#.......\n######....\n####.#..#.\n.#...#.##.\n#.#####.##\n..#.###...\n..#.......\n..#.###...")

(t/with-test
  (defn parse-input-tile [input-tile]
    (let [[header & rows] (s/split-lines input-tile)
          id (Integer/parseInt (s/replace header #"Tile |\:" ""))
          rows (mapv vec rows)]
      {:id id :rows rows}))
  (t/is (= {:id 123 :rows [[\. \#] [\# \#]]}
           (parse-input-tile "Tile 123:\n.#\n##"))))

(defn parse-input-tiles [input]
  (let [ts (s/split input #"\n\n")]
    (map parse-input-tile ts)))

(t/with-test
  (defn rotate-90-clock [matrix]
    (apply (partial mapv (comp vec reverse vector)) matrix))
  (t/is (= (rotate-90-clock [[1 2 3] [4 5 6] [7 8 9]])
           [[7 4 1] [8 5 2] [9 6 3]])))

(defn rotations [matrix]
  (take 4 (iterate rotate-90-clock matrix)))

(t/with-test
  (defn flip-v [matrix]
    (vec (reverse matrix)))
  (t/is (= (flip-v [[1 2] [3 4]])
           [[3 4] [1 2]])))

(t/with-test
  (defn flip-h [matrix]
    (mapv (comp vec reverse) matrix))
  (t/is (= (flip-h [[1 2] [3 4]])
           [[2 1] [4 3]])))

(t/with-test
  (defn flips [matrix]
    (set (for [h [flip-h identity]
               v [flip-v identity]
               :let [flip (comp h v)]]
           (flip matrix))))
  (t/is (= (flips [[1 2] [3 4]])
           #{[[1 2] [3 4]]
             [[3 4] [1 2]]
             [[2 1] [4 3]]
             [[4 3] [2 1]]})))

(defn extrapolate-matrices [matrix]
  (->> matrix
       (flips)
       (mapcat rotations)
       (set)))

(defn extrapolate-tiles [tile]
  (let [matrices (extrapolate-matrices (:rows tile))]
    (set (map #(assoc tile :rows %) matrices))))

(t/with-test
  (defn with-edges [tile]
    (let [rows (:rows tile)
          cols (apply (partial mapv vector) rows)
          top (first rows)
          bottom (last rows)
          left (first cols)
          right (last cols)]
      (assoc tile :top top :bottom bottom :left left :right right)))
  (t/is (= (with-edges {:id 1 :rows [[1 2] [3 4]]})
           {:id 1 :rows [[1 2] [3 4]]
            :top [1 2] :bottom [3 4] :left [1 3] :right [2 4]})))

(def sides [:top :bottom :left :right])

(defn indexed-by-side [tiles]
  (zipmap sides
          (map #(group-by % tiles) sides)))


(defn neighbor-coords [coord]
  (for [rd (range -1 2)
        cd (range -1 2)
        :when (not= (Math/abs rd) (Math/abs cd))]
      (mapv + coord [rd cd])))

(defn neighbors [grid coord]
  (let [[t l r b :as coords] (neighbor-coords coord)]
    (zipmap [:top :left :right :bottom]
            (map #(get-in grid %) coords))))

(def opposing-side (into {} [[:left :right]
                             [:right :left]
                             [:top :bottom]
                             [:bottom :top]]))

(defn candidates [indexed-by-side spoken-for neighbors]
  (let [unspoken-for (->> indexed-by-side
                          :bottom
                          vals
                          (flatten)
                          (filter #(not (spoken-for (:id %)))))
        neighbors (into {} (filter second neighbors))]
    (reduce (fn [acc [neighbor-dir neighbor]]
              (filter (fn [candidate]
                        (let [my-side (neighbor-dir candidate)
                              his-side ((opposing-side neighbor-dir) neighbor)]
                          (= my-side his-side)))
                      acc))
            unspoken-for
            neighbors)))


(defn arrangement
  ([indexed-by-side grid coord]
   (let [spoken-for (set (map :id (flatten grid)))
         neighbors (neighbors grid coord)
         empty-neighbor-coords (->> (neighbor-coords coord)
                                    (filter #(false? (get-in grid %))))
         candidates (candidates indexed-by-side spoken-for neighbors)]
     (cond
       (every? identity (flatten grid)) grid
       (empty? candidates) nil
       :else (some #(arrangement indexed-by-side
                                 (assoc-in grid coord %)
                                 (first empty-neighbor-coords))
                   candidates)))))

(defn arrange [input-tiles]
  (let [dim (int (Math/sqrt (count input-tiles)))
        all-tiles (->> input-tiles
                       (mapcat extrapolate-tiles)
                       (map with-edges))
        indexed-by-side (indexed-by-side all-tiles)
        grid (->> (vec (repeat dim false))
                  (repeat dim)
                  (vec))]
    (some #(arrangement indexed-by-side
                        (assoc-in grid [0 0] %)
                        [0 1])
          all-tiles)))

(defn corner-ids [grid]
  (let [h (map :id (first grid))
        l (map :id (last grid))]
    [(first h) (last h) (first l) (last l)]))

(t/with-test
  (defn strip-edges [matrix]
    (->> matrix
         (rest)
         (butlast)
         (mapv #(-> % rest butlast vec))))
  (t/is (= (strip-edges [[1 2 3] [4 5 6] [7 8 9]])
           [[5]])))

(t/with-test
  (defn unite-matrices [grid]
    (reduce (fn [acc grid-row]
              (->> (apply interleave grid-row)
                   (partition (count grid-row))
                   (map #(apply concat %))
                   (mapv vec)
                   (concat acc)))
            []
            grid))
  (t/is (= (unite-matrices [[[[1 2]
                              [3 4]] [[5 6]
                                      [7 8]]]
                            [[[9 10]
                              [11 12]] [[13 14]
                                        [15 16]]]])
           [[1 2 5 6]
            [3 4 7 8]
            [9 10 13 14]
            [11 12 15 16]])))

(def monster-s "                  # \n#    ##    ##    ###\n #  #  #  #  #  #   ")

(def monster-coords
  (let [grid (->> (s/split-lines monster-s)
                  (mapv vec))]
    (for [r (range (count grid))
          c (range (count (first grid)))
          :when (= \# (get-in grid [r c]))]
      [r c])))

(defn monster-at-coord? [grid coord]
  (let [coords (map #(mapv + coord %) monster-coords)
        cells (map #(get-in grid %) coords)]
    (every? #{\#} cells)))


(defn num-monsters [grid]
  (->> (for [r (range (count grid))
             c (range (count (first grid)))]
         [r c])
       (map (partial monster-at-coord? grid))
       (filter identity)
       (count)))

(time
  (let [grid (->> input
                  (parse-input-tiles)
                  (arrange))
        matrices (map #(map :rows %) grid)
        stripped (map #(map strip-edges %) matrices)
        united (unite-matrices stripped)
        orientations (extrapolate-matrices united)
        num-monsters (some #(let [n (num-monsters %)]
                              (when (not= 0 n)
                                n))
                           orientations)
        num-waves (count (filter #{\#} (flatten united)))]
    (prn "A:" (apply * (corner-ids grid)))
    (prn "B:" (- num-waves (* num-monsters (count monster-coords))))))

(t/run-tests 'aoc.2020.day.20)